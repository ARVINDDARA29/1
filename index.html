<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="monetag" content="58e2954bf0a854d2f0d747ecce1e8bbc">
    <meta name="b448b54f4ed44237d86986f5a565b98127a55ba8" content="b448b54f4ed44237d86986f5a565b98127a55ba8" />
    <title>BISHNOI 29</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .app-wrapper {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            background-color: #2d3748; /* Slightly lighter dark */
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            flex-grow: 1;
            animation: fadeIn 0.5s ease-in-out;
        }
        .screen.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .button-primary {
            background: linear-gradient(45deg, #f0932b, #e84393);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(232, 67, 147, 0.4);
            border: none;
        }
        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 67, 147, 0.5);
        }
        .button-secondary {
            background-color: #4a5568;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .offer-card {
            background-color: #4a5568;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .offer-card:hover {
            border-color: #f0932b;
            transform: scale(1.05);
        }
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 40;
        }
        .modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #48bb78;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .toast.show {
            opacity: 1;
        }
        .login-input {
            background-color: #4a5568;
            border: 1px solid #718096;
            color: #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .login-input::placeholder {
            color: #a0aec0;
        }
        .login-input:focus {
            outline: none;
            border-color: #e84393;
            box-shadow: 0 0 0 3px rgba(232, 67, 147, 0.3);
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <main>
            <!-- Loading Screen -->
            <div id="loading-screen" class="screen active justify-center items-center p-8">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-pink-500"></div>
                <h1 class="text-2xl font-bold mt-8">‡§ê‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</h1>
            </div>

            <!-- Login Screens -->
            <div id="main-login-screen" class="screen flex-col justify-center items-center p-8 space-y-6 text-center">
                <h2 class="text-4xl font-bold text-white mb-8">BISHNOI 29 ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! üíé</h2>
                <button id="email-signup-btn" class="button-primary w-full max-w-sm">‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç (‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°)</button>
                <button id="email-login-btn" class="button-secondary w-full max-w-sm">‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç (‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°)</button>
                <button id="continue-as-guest-btn" class="button-secondary w-full max-w-sm">‡§ó‡•á‡§∏‡•ç‡§ü ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç</button>
            </div>
            <div id="guest-name-screen" class="screen flex-col justify-center items-center p-8 space-y-6">
                <button class="back-btn absolute top-6 left-6 p-3 rounded-full hover:bg-gray-600"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-3xl font-bold text-white">‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?</h2>
                <input type="text" id="guest-name-input" placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="login-input w-full max-w-sm text-lg text-center">
                <button id="create-guest-user-btn" class="button-primary w-full max-w-sm">‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç</button>
            </div>
            <div id="email-signup-screen" class="screen flex-col justify-center items-center p-8 space-y-4">
                <button class="back-btn absolute top-6 left-6 p-3 rounded-full hover:bg-gray-600"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-3xl font-bold text-white mb-4">‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Å</h2>
                <input type="text" id="signup-name-input" placeholder="‡§Ö‡§™‡§®‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="login-input w-full max-w-sm">
                <input type="email" id="signup-email-input" placeholder="‡§à‡§Æ‡•á‡§≤ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="login-input w-full max-w-sm">
                <input type="password" id="signup-password-input" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (min. 6 char)" class="login-input w-full max-w-sm">
                <button id="signup-btn" class="button-primary w-full max-w-sm mt-4">‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
             <div id="email-login-screen" class="screen flex-col justify-center items-center p-8 space-y-4">
                <button class="back-btn absolute top-6 left-6 p-3 rounded-full hover:bg-gray-600"><i data-lucide="arrow-left"></i></button>
                <h2 class="text-3xl font-bold text-white mb-4">‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç</h2>
                <input type="email" id="login-email-input" placeholder="‡§à‡§Æ‡•á‡§≤ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="login-input w-full max-w-sm">
                <input type="password" id="login-password-input" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="login-input w-full max-w-sm">
                <button id="email-login-submit-btn" class="button-primary w-full max-w-sm mt-4">‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç</button>
            </div>

            <!-- Home Screen -->
            <div id="home-screen" class="screen p-6 space-y-6">
                <header class="flex justify-between items-center">
                    <h1 id="welcome-message" class="text-2xl font-bold">‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ!</h1>
                    <div class="bg-gray-900 px-4 py-2 rounded-full flex items-center gap-2">
                        <i data-lucide="gem" class="text-yellow-400"></i>
                        <span id="coin-balance" class="font-bold text-lg">0</span>
                    </div>
                </header>

                <div class="bg-gray-700 p-4 rounded-lg space-y-2">
                    <p class="text-sm text-gray-400">‡§Ü‡§™‡§ï‡•Ä ‡§Ø‡•Ç‡§ú‡§∞ ‡§Ü‡§à‡§°‡•Ä</p>
                    <div class="flex items-center justify-between gap-4">
                        <p id="user-id-display" class="font-mono text-sm break-all bg-gray-800 p-2 rounded-md flex-grow"></p>
                        <button id="copy-id-btn" class="bg-pink-500 text-white px-3 py-2 rounded-lg hover:bg-pink-600 transition">‡§ï‡•â‡§™‡•Ä</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4 pt-8">
                    <button id="earn-btn" class="button-primary py-4 text-lg flex items-center justify-center gap-3">
                        <i data-lucide="dollar-sign"></i>
                        <span>‡§´‡•ç‡§∞‡•Ä ‡§ï‡•â‡§á‡§Ç‡§∏ ‡§™‡§æ‡§è‡§Ç</span>
                    </button>
                    <button id="withdraw-btn" class="button-secondary py-4 text-lg flex items-center justify-center gap-3">
                        <i data-lucide="send"></i>
                        <span>‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç (Withdraw)</span>
                    </button>
                </div>
                 <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl mt-4">‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü</button>
            </div>

            <!-- Earn Diamonds Screen -->
            <div id="earn-screen" class="screen p-6 space-y-6">
                <header class="flex items-center">
                    <button class="back-btn p-2 rounded-full hover:bg-gray-600"><i data-lucide="arrow-left"></i></button>
                    <h1 class="text-xl font-bold mx-auto">‡§ï‡•â‡§á‡§Ç‡§∏ ‡§ï‡§Æ‡§æ‡§è‡§Ç</h1>
                </header>
                <div class="bg-blue-600 p-4 rounded-lg text-white text-center font-bold">
                    <p>‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§ 5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§ï‡•â‡§á‡§® ‡§Ü‡§™‡§ï‡•á ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡§°‡§º ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§</p>
                </div>
                <div id="banners-container" class="space-y-4">
                    <div class="p-2 bg-gray-800 rounded-lg">
                        <p class="text-center text-xs text-gray-500 mb-1">‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® 1</p>
                        <script async="async" data-cfasync="false" src="//pl27209153.profitableratecpm.com/4e2d6d16c1332f7c73b28bca760b3ec9/invoke.js"></script>
                        <div id="container-4e2d6d16c1332f7c73b28bca760b3ec9"></div>
                    </div>
                     <div class="p-2 bg-gray-800 rounded-lg">
                        <p class="text-center text-xs text-gray-500 mb-1">‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® 2</p>
                        <script type="text/javascript">
                            atOptions = {
                                'key' : '0d15173de61272c3e2bb15f8677bb5c5',
                                'format' : 'iframe',
                                'height' : 250,
                                'width' : 300,
                                'params' : {}
                            };
                        </script>
                        <script type="text/javascript" src="//www.highperformanceformat.com/0d15173de61272c3e2bb15f8677bb5c5/invoke.js"></script>
                    </div>
                </div>
            </div>

            <!-- Withdraw Screen -->
            <div id="withdraw-screen" class="screen p-6 space-y-6">
                <header class="flex items-center">
                    <button class="back-btn p-2 rounded-full hover:bg-gray-600"><i data-lucide="arrow-left"></i></button>
                    <h1 class="text-xl font-bold mx-auto">‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</h1>
                </header>
                <div class="grid grid-cols-1 gap-4 pt-8">
                    <button class="withdraw-option-btn button-primary py-8 text-2xl" data-game="Google Play">
                        Google Play Redeem Code
                    </button>
                </div>
            </div>
            
            <!-- Offer Screen -->
            <div id="offer-screen" class="screen p-6 space-y-6">
                 <header class="flex items-center">
                    <button class="back-btn p-2 rounded-full hover:bg-gray-600"><i data-lucide="arrow-left"></i></button>
                    <h1 id="offer-title" class="text-xl font-bold mx-auto">Offers</h1>
                </header>
                <div id="offers-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
                </div>
            </div>
        </main>
    </div>

    <!-- Modals & Toasts -->
    <div id="modal-container" class="hidden">
        <div class="modal-backdrop"></div>
        <div id="uid-modal" class="modal space-y-4">
            <h3 id="uid-modal-title" class="text-xl font-bold text-center">Enter Your Game UID</h3>
            <input type="text" id="uid-input" placeholder="Please enter your UID here" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-pink-500">
            <div class="flex gap-4">
                <button id="uid-cancel-btn" class="flex-1 button-secondary">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                <button id="uid-submit-btn" class="flex-1 button-primary">‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
        <div id="message-modal" class="modal space-y-4 text-center">
             <h3 id="message-modal-title" class="text-xl font-bold">Message</h3>
             <p id="message-modal-text"></p>
             <button id="message-modal-ok-btn" class="w-full button-primary">‡§†‡•Ä‡§ï ‡§π‡•à</button>
        </div>
    </div>
    <div id="toast-container"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Firebase Configuration and Global Variables ---
        const firebaseConfig = {
            apiKey: "AIzaSyAkkS8wmSnkQfTGydbPe-i1C7mO0w5z8j4",
            authDomain: "jai-shree-ram-a9e73.firebaseapp.com",
            projectId: "jai-shree-ram-a9e73",
            storageBucket: "jai-shree-ram-a9e73.appspot.com",
            messagingSenderId: "557868202170",
            appId: "1:557868202170:web:a2627a26b7ee452075aa83"
        };
        
        let app, db, auth, currentUser, userData, userId, unsubscribeUser;
        let screenHistory = [];
        let currentOffer = null;
        let hasEarnedFromBanner = false;

        // --- DOM Elements ---
        const allScreens = document.querySelectorAll('.screen');
        const modalContainer = document.getElementById('modal-container');

        // --- Core Application Flow and UI Management ---
        /**
         * Hides all screens and shows the one with the given ID.
         * @param {string} screenId The ID of the screen to show.
         * @param {boolean} isNav True if this is a primary navigation, false if a sub-screen.
         */
        function showScreen(screenId, isNav = false) {
            console.log(`Navigating to: ${screenId}`);
            const currentActive = document.querySelector('.screen.active');
            if (currentActive && currentActive.id !== screenId && !isNav) {
                screenHistory.push(currentActive.id);
            }
            if (isNav) screenHistory = [];

            allScreens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            lucide.createIcons();
        }

        /**
         * Navigates back to the previous screen in the history.
         */
        function goBack() {
            if (screenHistory.length > 0) {
                const lastScreenId = screenHistory.pop();
                showScreen(lastScreenId, true);
            } else {
                if (currentUser) {
                    showScreen('home-screen', true);
                } else {
                    showScreen('main-login-screen', true);
                }
            }
        }
        
        /**
         * Displays a toast notification.
         * @param {string} message The message to display.
         * @param {number} duration The duration in milliseconds.
         */
        function showToast(message, duration = 3000) {
            const toastId = `toast-${Date.now()}`;
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = 'toast';
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, duration);
        }
        
        /**
         * Shows a modal with a custom message.
         * @param {string} title The modal title.
         * @param {string} text The modal text content.
         * @param {function} onOk The function to call when the OK button is clicked.
         */
        function showMessageModal(title, text, onOk) {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-text').textContent = text;
            modalContainer.classList.remove('hidden');
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('uid-modal').classList.add('hidden');
            if(onOk) {
                document.getElementById('message-modal-ok-btn').onclick = onOk;
            } else {
                document.getElementById('message-modal-ok-btn').onclick = hideModals;
            }
        }

        /**
         * Hides all modals.
         */
        function hideModals() {
            modalContainer.classList.add('hidden');
        }

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            try {
                // Initialize Firebase app and services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set up the authentication state listener
                // This listener determines the initial screen after Firebase is ready
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // A user is signed in.
                        currentUser = user;
                        userId = user.uid;
                        await setupUser(user.uid);
                    } else {
                        // No user is signed in. Show the login screen.
                        currentUser = null;
                        userId = null;
                        userData = null;
                        if(unsubscribeUser) unsubscribeUser(); // Unsubscribe from old user data
                        showScreen('main-login-screen');
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                // If Firebase fails to initialize, show a clear error message to the user.
                document.getElementById('loading-screen').innerHTML = '<p class="text-red-500 text-center">‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§</p>';
            }
        }

        /**
         * Sets up a real-time listener for user data.
         * @param {string} uid The user ID.
         */
        async function setupUser(uid) {
            const userRef = doc(db, "ffusers", uid);
            // First, unsubscribe from any previous listener
            if(unsubscribeUser) unsubscribeUser();

            // Then, set up the new listener for the current user's document
            unsubscribeUser = onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    // User document exists, update the UI with the data
                    userData = docSnap.data();
                    updateUI();
                    showScreen('home-screen');
                } else {
                    console.warn(`User document for ${uid} does not exist yet.`);
                    // If the user document doesn't exist, create it.
                    // This handles new users who just signed up.
                    setDoc(userRef, {
                        name: auth.currentUser.displayName || auth.currentUser.email || "Guest",
                        uid: auth.currentUser.uid,
                        coins: 0,
                        createdAt: serverTimestamp()
                    }).then(() => {
                        // After creation, show the home screen
                        showScreen('home-screen');
                    });
                }
            }, (error) => {
                console.error("Error in user snapshot listener:", error);
                showMessageModal("Connection Error", "Could not sync user data. Please try again later.");
            });
        }

        /**
         * Updates the UI with the latest user data.
         */
        function updateUI() {
            if (!userData) return;
            document.getElementById('welcome-message').textContent = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ${userData.name}!`;
            document.getElementById('coin-balance').textContent = parseFloat(userData.coins || 0).toFixed(2);
            document.getElementById('user-id-display').textContent = userData.uid;
        }

        // --- Login and Signup Handlers ---
        async function handleGuestSignIn() {
            const name = document.getElementById('guest-name-input').value.trim();
            if (!name) {
                showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§");
                return;
            }
            try {
                // Sign in anonymously
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Guest sign-in error:", error);
                showMessageModal("Error", "Could not sign in as guest.");
            }
        }

        async function handleEmailSignup() {
            const name = document.getElementById('signup-name-input').value.trim();
            const email = document.getElementById('signup-email-input').value.trim();
            const password = document.getElementById('signup-password-input').value.trim();

            if (!name || !email || !password) {
                showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç‡•§"); return;
            }
            if (password.length < 6) {
                showToast("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 6 ‡§µ‡§∞‡•ç‡§£‡•ã‡§Ç ‡§ï‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§"); return;
            }

            try {
                // Create a new user with email and password
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Signup error:", error.code, error.message);
                if (error.code === 'auth/email-already-in-use') {
                    showMessageModal("Signup Error", "‡§Ø‡§π ‡§à‡§Æ‡•á‡§≤ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§â‡§™‡§Ø‡•ã‡§ó ‡§Æ‡•á‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§Ö‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§");
                } else if (error.code === 'auth/weak-password') {
                     showMessageModal("Signup Error", "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§π‡•Å‡§§ ‡§ï‡§Æ‡§ú‡•ã‡§∞ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ö‡•Å‡§®‡•á‡§Ç‡•§");
                } else if (error.code === 'auth/invalid-email') {
                     showMessageModal("Signup Error", "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§");
                } else {
                    showMessageModal("Signup Error", `‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡§§‡§æ: ${error.code}`);
                }
            }
        }

        async function handleEmailLogin() {
            const email = document.getElementById('login-email-input').value.trim();
            const password = document.getElementById('login-password-input').value.trim();
            if (!email || !password) {
                showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§à‡§Æ‡•á‡§≤ ‡§î‡§∞ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§"); return;
            }
            try {
                // Sign in with email and password
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error.code, error.message);
                 if (error.code === 'auth/invalid-credential') {
                    showMessageModal("Login Error", "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§");
                } else {
                    showMessageModal("Login Error", `‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡§§‡§æ: ${error.code}`);
                }
            }
        }

        function handleLogout() {
            signOut(auth).catch(error => {
                console.error("Logout error:", error);
                showMessageModal("Error", "Could not log out.");
            });
        }
        
        // --- Coin Earning Logic ---
        async function addCoins() {
            if (userId) {
                const value = 0.5; // Fixed value for earning coins
                const userRef = doc(db, "ffusers", userId);
                try {
                    await updateDoc(userRef, {
                        coins: increment(value)
                    });
                    showMessageModal("‡§∏‡§´‡§≤‡§§‡§æ!", `‡§Ü‡§™‡§ï‡•á ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç +${value.toFixed(2)} ‡§ï‡•â‡§á‡§® ‡§ú‡•ã‡§°‡§º ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§`, () => {
                        hideModals();
                        showScreen('home-screen', true);
                    });
                } catch (error) {
                    console.error("Error updating coins:", error);
                    showToast("Error updating coins.");
                }
            } else {
                showMessageModal("Error", "You must be logged in to claim coins.");
            }
        }


        // --- Event Listeners ---
        window.addEventListener('load', () => {
            initializeFirebase();
        });

        document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', goBack));
        
        document.getElementById('email-signup-btn').addEventListener('click', () => showScreen('email-signup-screen'));
        document.getElementById('email-login-btn').addEventListener('click', () => showScreen('email-login-screen'));
        document.getElementById('continue-as-guest-btn').addEventListener('click', () => showScreen('guest-name-screen'));
        
        document.getElementById('create-guest-user-btn').addEventListener('click', handleGuestSignIn);
        document.getElementById('signup-btn').addEventListener('click', handleEmailSignup);
        document.getElementById('email-login-submit-btn').addEventListener('click', handleEmailLogin);

        document.getElementById('copy-id-btn').addEventListener('click', async () => {
            if(!userData || !userData.uid) return;
            const textToCopy = userData.uid;
            
            try {
                await navigator.clipboard.writeText(textToCopy);
                showToast("User ID copied!");
            } catch (err) {
                console.warn("Clipboard API failed, using fallback. Error:", err);
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("User ID copied!");
                } catch (execErr) {
                    console.error('Fallback copy failed:', execErr);
                    showToast("Copy failed!", 3000);
                }
                document.body.removeChild(textArea);
            }
        });

        // The earn button now navigates and then automatically adds coins after a delay
        document.getElementById('earn-btn').addEventListener('click', () => {
            showScreen('earn-screen');
            // This is the key part of the logic. We use a timer to simulate a user
            // having enough time to interact with the ad before getting the reward.
            // This bypasses the security restriction of not being able to detect
            // if a user actually left the page and came back.
            setTimeout(addCoins, 5000); // Wait 5 seconds, then add coins
        });
        document.getElementById('withdraw-btn').addEventListener('click', () => showScreen('withdraw-screen'));
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        
        // Withdraw Screen Logic
        const offers = {
            "Google Play": [
                { coins: 200, redeem: 30 },
                { coins: 400, redeem: 60 },
                { coins: 600, redeem: 90 },
                { coins: 800, redeem: 120 },
                { coins: 1000, redeem: 150 },
                { coins: 1200, redeem: 180 },
                { coins: 1400, redeem: 210 },
                { coins: 1600, redeem: 240 },
                { coins: 1800, redeem: 270 },
                { coins: 2000, redeem: 300 },
            ]
        };

        document.querySelectorAll('.withdraw-option-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const game = btn.dataset.game;
                const gameOffers = offers[game];
                
                document.getElementById('offer-title').textContent = `${game} Offers`;
                
                const container = document.getElementById('offers-container');
                container.innerHTML = ''; 
                
                gameOffers.forEach(offer => {
                    const card = document.createElement('div');
                    card.className = 'offer-card text-center';
                    card.innerHTML = `
                        <p class="text-3xl font-bold text-yellow-400">‚Çπ${offer.redeem}</p>
                        <p class="text-lg">Redeem Code</p>
                        <p class="mt-4 bg-gray-800 inline-block px-4 py-1 rounded-full">${offer.coins} Coins</p>
                    `;
                    card.addEventListener('click', () => handleOfferClick(offer, game));
                    container.appendChild(card);
                });
                showScreen('offer-screen');
            });
        });
        
        function handleOfferClick(offer, game) {
            if (userData && userData.coins >= offer.coins) {
                currentOffer = { ...offer, game };
                document.getElementById('uid-modal-title').textContent = `Enter Your Email for Redeem Code`;
                document.getElementById('uid-input').placeholder = "Enter your email here";
                modalContainer.classList.remove('hidden');
                document.getElementById('uid-modal').classList.remove('hidden');
                document.getElementById('message-modal').classList.add('hidden');
            } else {
                showMessageModal("Insufficient Coins", "You do not have enough coins for this offer.");
            }
        }
        
        // UID Modal Logic
        document.getElementById('uid-cancel-btn').addEventListener('click', hideModals);
        document.getElementById('message-modal-ok-btn').addEventListener('click', hideModals);
        
        document.getElementById('uid-submit-btn').addEventListener('click', async () => {
            const emailAddress = document.getElementById('uid-input').value.trim();
            if (emailAddress === '') {
                showToast("Please enter a valid email address.", 3000);
                return;
            }
            
            if (!currentOffer || !userId) return;

            hideModals();
            showToast("Processing your request...", 4000);

            const userRef = doc(db, "ffusers", userId);
            const withdrawalsRef = collection(db, "withdrawals");

            try {
                await updateDoc(userRef, {
                    coins: increment(-currentOffer.coins)
                });

                await addDoc(withdrawalsRef, {
                    userId: userId,
                    game: currentOffer.game,
                    offer: currentOffer,
                    email: emailAddress,
                    status: "pending",
                    createdAt: serverTimestamp()
                });

                showMessageModal("‡§∏‡§´‡§≤‡§§‡§æ!", "‡§Ü‡§™‡§ï‡§æ Google Play redeem code 24 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡•á ‡§≠‡•Ä‡§§‡§∞ ‡§Ü‡§™‡§ï‡•á ‡§à‡§Æ‡•á‡§≤ ‡§™‡§∞ ‡§≠‡•á‡§ú ‡§¶‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§", () => {
                    hideModals();
                    showScreen('home-screen', true);
                });

            } catch (error) {
                console.error("Withdrawal Error:", error);
                showMessageModal("Error", "There was an error processing your request. Please try again.");
            } finally {
                document.getElementById('uid-input').value = '';
                currentOffer = null;
            }
        });

    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
